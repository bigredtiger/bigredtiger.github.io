<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Pac-man</title>
		<style>
			body {
				background-color: #000;
				color: #ddd;
				font-family: verdana, sans-serif;
				font-size: 12px;
				display: flex;
				justify-content: center;
				align-items: center;
				height: 93vh;
				margin: 0;
			}
			#container {
				display: flex;
				flex: 0;
				flex-flow: row wrap;
				background-color: blue;
				border-radius: 6px;
				/*padding: 20px;*/
			}
			.row {
				flex: 0 0 100%;
				display: flex;
			}
			.path {
				width: 20px;
				height: 20px;
				background-color: #000;
			}
			.wall {
				width: 20px;
				height: 20px;
				background-color: blue;
			}
			#pac {
				position: absolute;
				width: 20px;
				height: 20px;
				background-color: yellow;
				border-radius: 10px;
				margin-left: 20px;
				margin-top: 20px;
			}
		</style>
	</head>
	<body>
		<section id="container"></section>
		<script>
			class Pacman {
				constructor() {
					this.animationId;
					this.cont = true;
					this.step = 1;
					this.block = 20;
					this.left = 20;
					this.top = 20;
					this.prev = '';
					this.board = [
						[1,1,1,1,1,1,1,1,1,1,1],
						[1,0,0,0,0,0,0,0,0,0,1],
						[1,0,1,0,1,0,1,0,1,0,1],
						[0,0,0,0,1,0,1,0,0,0,0],
						[1,0,1,0,1,1,1,0,1,0,1],
						[1,0,0,0,0,0,0,0,0,0,1],
						[1,1,1,1,1,1,1,1,1,1,1]						
					];
					this.border = {
						topEnd: this.block,
						rightEnd: this.board[0].length * this.block - this.block,
						bottomEnd: this.board.length * this.block - this.block,
						leftEnd: this.block
					};					
					this.keyCode = {
						39: 'right',
						37: 'left',
						40: 'down',
						38: 'up'
					};
					this.init();
				}
				isPortal(dir) {
					if (Math.floor(this.left/this.block) === this.board[0].length - 1 && dir === 'right') {
						this.left = 0;
					} else if (Math.floor(this.left/this.block) < 0 && dir === 'left') {
						this.left = (this.board[0].length - 1) * this.block;
					}
				}
				isBarrier(dir) {
					const posLeft = this.left;
					const posTop = this.top;
					
					this.isPortal(dir);
					
					switch(dir) {
						case 'right':
							return (this.board[Math.round(posTop/this.block)] && 
								this.board[Math.round(posTop/this.block)][Math.floor(posLeft/this.block) + 1]);
						case 'left':
							return this.board[Math.round(posTop/this.block)][Math.ceil(posLeft/this.block) - 1];
						case 'up':
							return (this.board[Math.ceil(posTop/this.block) - 1] && 
								this.board[Math.ceil(posTop/this.block) - 1][Math.round(posLeft/this.block)]);
						case 'down':
							return (this.board[Math.floor(posTop/this.block) + 1] && 
								this.board[Math.floor(posTop/this.block) + 1][Math.round(posLeft/this.block)]);													
					}
				}
				go(dir) {						
					if (!this.isBarrier(dir) && this.cont) {
						
						const $pac = document.getElementById('pac');
						
						//console.log(this.top, this.left);
						switch(dir) {
							case 'right':
								this.top = Math.floor(this.top / 10) * 10;
								this.top % this.block ? this.top = this.top + 10 : this.top;
								this.left += this.step;
								$pac.style.marginTop = `${this.top}px`;
								$pac.style.marginLeft = `${this.left}px`;
								break;
							case 'left':
								this.top = Math.ceil(this.top / 10) * 10;
								this.top % this.block ? this.top = this.top - 10 : this.top;
								this.top % this.block && this.prev === 'down' ? this.top = this.top + 10 : 
									this.top % this.block && this.prev === 'up' ? this.top = this.top - 10 : this.top;
								//console.log('duh', this.top, this.left, this.top % this.block, this.prev);
								this.left -= this.step;
								$pac.style.marginTop = `${this.top}px`;
								$pac.style.marginLeft = `${this.left}px`;
								break;
							case 'up':
								this.left = Math.ceil(this.left / 10) * 10;
								this.left % this.block ? this.left = this.left - 10 : this.left;
								//console.log('duh', this.top, this.left);
								this.top -= this.step;
								$pac.style.marginTop = `${this.top}px`;
								$pac.style.marginLeft = `${this.left}px`;
								break;
							case 'down':
								this.left = Math.floor(this.left / 10) * 10;
								this.left % this.block ? this.left = this.left + 10 : this.left;
								this.top += this.step;
								$pac.style.marginTop = `${this.top}px`;
								$pac.style.marginLeft = `${this.left}px`;
								break;								
						}
						this.prev = dir;
						this.animationId = requestAnimationFrame(() => this.go(dir));
					}
				}
				events() {
					document.addEventListener('keydown', e => {
						const dir = this.keyCode[e.keyCode];
					
						if (dir) {
							if (this.animationId) {
								cancelAnimationFrame(this.animationId);
								this.cont = false;
								if (this.isBarrier(dir)) {
									this.cont = true;
									this.go(this.prev);
								} else {
									this.cont = true;
									this.go(dir);
								}
							} else {
								this.cont = true;
								this.go(dir);
							}
						}
					}, true);
				}
				renderPac() {
					const $container = document.getElementById('container');
					let tpl = '<div id="pac"></div>';
					$container.insertAdjacentHTML('beforeend', tpl);
				}
				renderBoard() {
					const max = this.board.length;
					let tpl = ``;
					for (let i = 0; i < max; i++) {
						for (let j = 0; j < this.board[i].length; j++) {
							if (j === 0) {
								tpl = `${tpl}<div class="row">`;
							}
							if (!this.board[i][j]) {
								tpl = `${tpl}<div class="path"></div>`;
							} else {
								tpl = `${tpl}<div class="wall"></div>`;
							}
							if (j === this.board[i].length - 1) {
								tpl = `${tpl}</div>`;
							}
						}
					}
					document.getElementById('container').innerHTML = tpl;
				}
				init() {
					console.log('Started.');
					this.renderBoard();
					this.renderPac();
					this.events();
				}
			}
			new Pacman();
		</script>
	</body>
</html>